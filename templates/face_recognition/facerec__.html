<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Face Recognition | STTB</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> -->
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 320px;
            height: 480px;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: sans-serif;
        }
        .box_padding {
            padding: 3px;
        }
        .center_all {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .video_stream {
            max-width: 320px;
            max-height: 240px;
        }
        .card {
            margin-bottom: 10px;
        }
        .button_width {
            width: 100%;
        }
        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .button-container form {
            width: 80%;
            margin: 2px 0;
        }
        .button-container button {
            width: 100%;
        }
        .name_p {
            font-weight: bold;
            font-size: 22px;
        }
    </style>
</head>
<body>
    <!-- Display flash messages in a modal -->
    <!-- {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="modal fade" id="notificationModal">
                <div class="modal-dialog" style="width:303px;" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            {% for message in messages %}
                                <p>{{ message }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    autoHideModal();
                });
            </script>
        {% endif %}
    {% endwith %} -->

    <div class="center_all">
        <div id="name_" class="name_p flex">Nama</div>
    </div>

    <div>
        <img class="rounded video_stream" src="{{ url_for('video_feed')}}" alt="Camera Error">
    </div>

    <div class="d-flex flex-column">
        <div class="center_all" id="datetime">
            <!-- <p id="datetime" class="center_all"></p> -->
        </div>
       <!-- <div class="center_all">
            <div class="flex">Nama : </div>
            <div id="name_">-</div>
       </div> !--> 
    </div>

    <!-- <div class="button-container">
        <form id="form_in" action="{{ url_for('submit_facerec_') }}" method="post" onsubmit="updateHiddenInput('form_in')">
            <input type="hidden" id="time_category" name="time_category" value="IN"> 
            <input type="hidden" id="name_input" name="name_input" value=""> 
            <button type="submit" class="center_all btn btn-lg btn-success button_width" id="IN">IN</button>
        </form>
        <form id="form_out" action="{{ url_for('submit_facerec_') }}" method="post" onsubmit="updateHiddenInput('form_out')">
            <input type="hidden" id="time_category" name="time_category" value="OUT">
            <input type="hidden" id="name_input" name="name_input" value=""> 
            <button type="submit" class="center_all btn btn-lg btn-danger button_width" id="OUT">OUT</button>
        </form>
    </div> -->

    <form id="form_submit" action="{{ url_for('submit_facerec__') }}" method="post">
        <input type="hidden" id="name_input" name="name_input" value=""> 
    </form>

    <div class="row">
        <div class="col-6 center_all" style="font-size: 10px;">Nama</div>
        <!-- <div class="col-2 center_all" style="font-size: 10px;">Kategori</div> -->
        <div class="col-6 center_all" style="font-size: 10px;">Waktu</div>
    </div>
    <div class="row">
        {% for row in data_csv %}
        <div class="col-6 center_all" style="font-size: 10px;">{{ row[0] }}</div>
        <!-- <div class="col-2 center_all" style="font-size: 10px;">{{ row[1] }}</div> -->
        <div class="col-6 center_all" style="font-size: 10px;">{{ row[2] }}</div>
        {% endfor %}
    </div>

    <div class="center_all flex" style="font-size: 10px;">{{ ip_address }}</div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mt-3">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}
</body>
</html>
<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery-3.5.1.slim.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>

<script language="javascript">
    function updateName() {
        var name_ = document.getElementById('name_');
        var originalText = name_.textContent;
        setInterval(function() {
            if (name_.textContent != originalText) {
                //console.log(name_.textContent);
                originalText = name_.textContent;
            }
        }, 500);
    }
    updateName();

    function updateDateTime() {
        var now = new Date();
        var days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        var day = days[now.getDay()];
        var date = now.getDate().toString().padStart(2, '0');
        var month = (now.getMonth() + 1).toString().padStart(2, '0'); // Bulan dimulai dari 0
        var year = now.getFullYear();
        var hours = now.getHours().toString().padStart(2, '0');
        var minutes = now.getMinutes().toString().padStart(2, '0');
        var seconds = now.getSeconds().toString().padStart(2, '0');

        var currentDate = day + ', ' + date + '/' + month + '/' + year;
        var currentTime = hours + ':' + minutes + ':' + seconds;

        document.getElementById('datetime').innerText = currentDate + ' ' + currentTime;
    }

    function startDateTime() {
        updateDateTime(); // Panggil pertama kali untuk menampilkan waktu langsung
        setInterval(updateDateTime, 1000); // Perbarui waktu setiap detik
    }

    window.onload = startDateTime;

    function updateHiddenInput(formId) {
        // Get the value of the h5 element with id "name_"
        var name_ = document.getElementById('name_').textContent;
        console.log(name_)
        // Set this value to the hidden input field with id "name_input"
        //document.getElementById('name_input').value = originalText;
        //document.querySelector(`#${formId} input[name="name_input"]`).value = name_;
        document.querySelector(`#${formId} input[name="name_input"]`).value = name_;
    }

    // Function to hide the modal automatically after a few seconds
    function autoHideModal() {
        var modal = new bootstrap.Modal(document.getElementById('notificationModal'));
        modal.show();
        setTimeout(function() {
            modal.hide();
        }, 3000); // Hide after 3 seconds
    }

    // Function to refresh the page every 60 seconds
    function autoRefresh() {
        location.reload();
    }

    // Function to fetch predictions from the server
    function updatePredictions() {
        fetch('/pred')
            .then(response => response.json())
            .then(data => {
                document.getElementById('name_').textContent = data.name_;
            });
    }

    // Call autoRefresh every 60 seconds
    setInterval(autoRefresh, 60000);

    // Call updatePredictions every second
    setInterval(updatePredictions, 500);

    let lastName = "{{ last_index }}";
    /**
     * Function to check the condition and submit the form
     * Submits the form if the name element is not empty, not one of the invalid names,
     * and the current name is different from the previous name
     */
    function submitForm() {
        // Get the name element
        const nameElement = document.getElementById('name_');
        
        // Get the current name
        const currentName = nameElement.textContent;
        
        // Define the list of invalid names
        const invalidNames = ["Tidak Dikenali", "Tidak Terdeteksi", "-", " ", "", "Palsu", "Face Recognition"];
        
        // Check if the name element is not empty, not one of the invalid names,
        // and the current name is different from the previous name
        if (currentName && !invalidNames.includes(currentName) && currentName !== lastName) {
            document.getElementById('name_input').value = currentName;
            
            // Submit the form
            document.getElementById('form_submit').submit();
            
            // Update the previous name
            lastName = currentName;
        }
    }
    // Set interval to check the condition and submit the form every 1 second
    setInterval(submitForm, 3000);
</script>
